# Configure BI to publish observability data

## Container-based environments

1. Switch to the code-view and add the following imports to the Ballerina program:
```
import ballerinax/metrics.logs as _;
import ballerinax/jaeger as _;
```

2. Add the following configuration to the `Ballerina.toml` file:
```
[build-options]
observabilityIncluded=true
```

3. Create a toml file with the below content and mount it to the BI container.
```
[ballerina.observe]
tracingEnabled=true
tracingProvider="jaeger"
metricsLogsEnabled=true

[ballerinax.jaeger]
agentHostname="data-prepper.observability.svc.cluster.local"
agentPort=4317
samplerType="const"
samplerParam=1.0
reporterFlushInterval=2000
reporterBufferSize=1000
```

4. Add the `component: "wso2ballerina"` and `app: "<app-name>"` labels to the BI Kubernetes deployment file.

Once updated, Kubernetes deployment file for BI would look like the below (`files/shipments-config.toml` is the toml file created in step 2):
```
---
apiVersion: "v1"
kind: "Service"
metadata:
  labels:
    app: "shipments"
  name: "shipments-svc"
spec:
  ports:
  - name: "port-1-shipment"
    port: 9101
    protocol: "TCP"
    targetPort: 9101
  selector:
    app: "shipments"
  type: "ClusterIP"
---
apiVersion: "apps/v1"
kind: "Deployment"
metadata:
  labels:
    app: "shipments"
  name: "shipments-deployment"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: "shipments"
  template:
    metadata:
      labels:
        app: "shipments"
        component: "wso2ballerina"
    spec:
      containers:
      - env:
        - name: "BAL_CONFIG_FILES"
          value: "/home/ballerina/conf/Config.toml:"
        image: "tmart/shipments:v1"
        lifecycle:
          preStop:
            exec:
              command:
              - "sleep"
              - "15"
        name: "shipments-deployment"
        ports:
        - containerPort: 9101
          name: "port-1-shipment"
          protocol: "TCP"
        resources:
          limits:
            memory: "512Mi"
            cpu: "500m"
          requests:
            memory: "100Mi"
            cpu: "200m"
        volumeMounts:
        - mountPath: "/home/ballerina/conf/"
          name: "shipments-configmap-volume"
          readOnly: false
      volumes:
      - configMap:
          name: "shipments-configmap"
        name: "shipments-configmap-volume"
---
apiVersion: "autoscaling/v2"
kind: "HorizontalPodAutoscaler"
metadata:
  labels:
    app: "shipments"
  name: "shipments-hpa"
spec:
  maxReplicas: 1
  metrics:
  - resource:
      name: "cpu"
      target:
        averageUtilization: 50
        type: "Utilization"
    type: "Resource"
  minReplicas: 1
  scaleTargetRef:
    apiVersion: "apps/v1"
    kind: "Deployment"
    name: "shipments-deployment"
---
apiVersion: "v1"
kind: "ConfigMap"
metadata:
  name: "shipments-configmap"
data:
  Config.toml: |
{% raw %}{{ .Files.Get "files/shipments-config.toml" | indent 4 }}{% endraw %}
```

## VM-based environments

1. Switch to the code mode and add the following imports to the Ballerina program:
```
import ballerinax/metrics.logs as _;
import ballerinax/jaeger as _;
```

2. Add the following configuration to the `Ballerina.toml` file:
```
[build-options]
observabilityIncluded=true
```

3. Create a `Config.toml` file with the below content and set a environment variable named `BAL_CONFIG_FILES` to point to the `Config.toml` file path.
```
[ballerina.observe]
tracingEnabled=true
tracingProvider="jaeger"
metricsLogsEnabled=true

[ballerinax.jaeger]
agentHostname="localhost"
agentPort=4317
samplerType="const"
samplerParam=1.0
reporterFlushInterval=2000
reporterBufferSize=1000
```

4. BI by default writes logs to the console. In VM-based environments, the observability solution reads logs from log files. Therefore, BI logs have to be directed to a log file. This can be done using one of the below two methods:

    - Run the jar file generated by BI by directing console output to a log file.

        ``bal run <bi-app>.jar > logs/app.log 2>&1 &``

    - Direct logs to a log file within the Ballerina program (See [writing Ballerina logs to a file](https://ballerina.io/spec/log/#4-writing-logs-to-a-file) ):

        ``var result = log:setOutputFile("./logs/app.log");``

5. Configure the fluentbit component of the observability solution to the read BI log files. This can be done by adding log file paths of all BI apps to the `<base-dir>/observability-resources/observability/vm/puppet/code/environments/production/modules/fluentbit/manifests/params.pp` file as below:

```
$bal_log_paths = ["/opt/bal_apps/shipments/logs/app.log", "/opt/bal_apps/inventory/logs/app.log", "/opt/bal_apps/crm/logs/app.log", "/opt/bal_apps/portal/logs/app.log"]
```
> Note that fluent bit will be started by the deployment script of the observability solution. Therefore, once the above log paths are updated, it is requried to restart fluent bit.